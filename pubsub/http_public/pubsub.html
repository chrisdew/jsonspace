<!doctype html>
<html>
  <head>  
    <meta charset="utf-8">  
    <title>comms placeholder</title>  
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script>
      var addMessage = function(message) {
        $('<li>' + message + '</li>').appendTo('#messages');
      };

      var ws_url = 'ws://' + location.host.split(':')[0] + ':8888/pubsub';
      console.log('ws_url', ws_url);
      var sock = false;

      // local application state
      var local_state = {
        channels: {}, // a set of currently subscribed channels
        watches: {}, // a set of currently watched channels
        username: null,
        ping: true
      };

      var path_array = window.location.pathname.split('/');
      local_state.username = path_array[2];


      // this function is overridden, once the socket has connected
      var send = function(data) {
        $('#comms_log').append('<li>cannot send:' + data + '</li>');
      };

      $(function() {
        sock = new WebSocket(ws_url);
        // TODO: add websocket reconnection logic
        sock.onopen = function() {
          $('#comms_log').append('<li>connected:' + ws_url + '</li>');
          // a send function, to aid logging
          send = function(data) {
            $('#comms_log').append('<li>sent:' + data + '</li>');
            sock.send(data);
          };
          sock.onmessage = function(message) {
            $('#comms_log').append('<li>rx:' + message.data + '</li>');
            var data = JSON.parse(message.data);
            handleMessageData(data);
          };
          setInterval(function() {
            if (local_state.ping) {
              send(JSON.stringify({ping:{}}));
            }
          }, 25000)
        };
        sock.onclose = function() {
          $('#comms_log').append('<li>websocket closed by server, please refresh page to continue</li>');
          send = function(data) { $('#comms_log').append('<li>cannot send:' + data + ', due to socket closure</li>'); };
        };
        sock.onerror = function(err) {
          $('#comms_log').append('<li>websocket error: ' + err + '</li>');
          send = function(data) { $('#comms_log').append('<li>cannot send:' + data + ', due to socket error</li>'); };
        };
      });

      function handleMessageData(data) {
        // we no longer base any logic on received messages
      }

      function addToChannels(channel) {
        if (!local_state.channels[channel]) {
          local_state.channels[channel] = true;
          refreshDisplay(this.local_state);
        }
      }

      function removeFromChannels(channel) {
        if (local_state.channels[channel]) {
          delete local_state.channels[channel];
          refreshDisplay(local_state);
        }
      }

      function addToWatched(channel) {
        if (!local_state.watches[channel]) {
          local_state.watches[channel] = true;
          refreshDisplay(this.local_state);
        }
      }

      function removeFromWatched(channel) {
        if (local_state.watches[channel]) {
          delete local_state.watches[channel];
          refreshDisplay(local_state);
        }
      }

      // A very weak substitute for ReactJS
      function refreshDisplay(local_state) {
        var ids = ['#publish_channel', '#unsubscribe_channel', '#unwatch_channel'];
        var options = [local_state.channels, local_state.channels, local_state.watches];
        for (var i in ids) {
          var id = ids[i];
          // add the channel options to the select
          var select = $(id);
          select.empty(); // remove existing options
          for (var channel in options[i]) {
            select.append('<option value="' + channel + '">' + channel + '</option>');
          }
        };
      }

      function handleSubscribeButtonClick() {
        console.log('handleSubscribeButtonClick');
        var channel = $('#subscribe_channel').val();

        // treat extra as JSON, if it parses, or as a string, if it doesn't
        var extra_str = $('#subscribe_extra').val();
        var extra;
        try {
          extra = JSON.parse(extra_str);
        } catch (e) {
          extra = extra_str;
        }

        var published_since = $('#subscribe_published_since').val();
        var request = {subscribe:{username:local_state.username,channel:channel,extra:extra}};
        if (published_since) request.subscribe.published_since = published_since;
        send(JSON.stringify(request));
        $('#subscribe_channel').val('');
        $('#subscribe_extra').val('');
        $('#subscribe_published_since').val('');
        addToChannels(channel);
        removeFromWatched(channel);
      }

      function handleUnsubscribeButtonClick() {
        console.log('handleUnsubscribeButtonClick');
        var channel = $('#unsubscribe_channel').val();
        send(JSON.stringify({unsubscribe:{username:local_state.username,channel:channel}}));
        removeFromChannels(channel);
        removeFromWatched(channel);
      }

      function handleWatchButtonClick() {
        console.log('handleWatchButtonClick');
        var channel = $('#watch_channel').val();
        send(JSON.stringify({watch:{username:local_state.username,channel:channel}}));
        $('#watch_channel').val('');
        removeFromChannels(channel);
        addToWatched(channel);
      }

      function handleUnwatchButtonClick() {
        console.log('handleUnwtachButtonClick');
        var channel = $('#unwatch_channel').val();
        send(JSON.stringify({unwatch:{channel:channel}}));
        removeFromChannels(channel);
        removeFromWatched(channel);
      }

      function handlePublishButtonClick() {
        console.log('handleSubscribeButtonClick');
        var channel = $('#publish_channel').val();
        var data = $('#message').val();
        send(JSON.stringify({publish:{channel:channel,data:data}}));
        $('#message').val('');
      }

      function handlePingClick() {
        local_state.ping = !local_state.ping;
        if (local_state.ping) {
          $('#ping').html('Stop Pinging');
        } else {
          $('#ping').html('Start Pinging');
        }
      }

    </script>
  </head>
  <body>
    <h1>pubsub placeholder app</h1>
    <h2>comms log:</h2>
    <ul id="comms_log"></ul>
    <br/>
    <h2>pings</h2>
    <form>
      <button id="ping" onclick="handlePingClick(); return false;">Stop Pinging</button>
    </form>
    <br/>
    <h2>subscribe to a new channel</h2>
    <form>
      <label>channel:<input id="subscribe_channel" type="text"></label>
      <label>extra: <input id="subscribe_extra" type="text"></label>
      <label>published_since (optional): <input id="subscribe_published_since" type="text"></label>
      <button id="subscribe" onclick="handleSubscribeButtonClick(); return false;">Subscribe</button>
    </form>
    <br/>
    <h2>unsubscribe from a channel</h2>
    <form>
      <select id="unsubscribe_channel"></select>
      <button id="unsubscribe" onclick="handleUnsubscribeButtonClick(); return false;">Unsubscribe</button>
    </form>
    <p>(if the select box has no options, you have not yet subscribed to any channels, since the server was started)</p>
    <br/>
    <h2>watch a new channel</h2>
    <form>
      <label>channel:<input id="watch_channel" type="text"></label>
      <button id="watch" onclick="handleWatchButtonClick(); return false;">Watch</button>
    </form>
    <br/>
    <h2>unwatch a channel</h2>
    <form>
      <select id="unwatch_channel"></select>
      <button id="unwatch" onclick="handleUnwatchButtonClick(); return false;">Unwatch</button>
    </form>
    <p>(if the select box has no options, you have not yet watched any channels, since the server was started)</p>
    <br/>
    <h2>publish a new message</h2>
    <form>
      <select id="publish_channel"></select>
      <input id="message" type="text">
      <button id="publish" onclick="handlePublishButtonClick(); return false;">Publish</button>
    </form>
    <p>(if the select box has no options, you have not yet subscribed to any channels, since the server was started)</p>
  </body>
</html>	
