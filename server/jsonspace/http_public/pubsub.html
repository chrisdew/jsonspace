<!doctype html>
<html>
  <head>  
    <meta charset="utf-8">  
    <title>comms placeholder</title>  
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script>
      var addMessage = function(message) {
        $('<li>' + message + '</li>').appendTo('#messages');
      };

      var path_array = window.location.pathname.split('/');
      var username = path_array[2];

      var ws_url = 'ws://localhost:8888/pubsub';
      console.log('ws_url', ws_url);
      var sock = false;

      // local application state
      var local_state = {
        recent_messages: {}
      };

      // this function is overridden, once the socket has connected
      var send = function(data) {
        $('#comms_log').append('<li>cannot send:' + data + '</li>');
      };

      $(function() {
        sock = new WebSocket(ws_url);
        // TODO: add websocket reconnection logic
        // TODO: add websocket error handling
        sock.onopen = function() {
          $('#comms_log').append('<li>connected:' + ws_url + '</li>');
          // a send function, to aid logging
          send = function(data) {
            $('#comms_log').append('<li>sent:' + data + '</li>');
            sock.send(data);
          };
          send(JSON.stringify({login:{username:username}}));
          sock.onmessage = function(message) {
            $('#comms_log').append('<li>rx:' + message.data + '</li>');
            var data = JSON.parse(message.data);
            handleMessageData(data);
          };
        };
      });

      function handleMessageData(data) {
        console.log('message data:', data);
        if (data.logged_in) return handleLoggedIn(data.logged_in);
        if (data.subscribed) return handleSubscribed(data.subscribed);
        if (data.unsubscribed) return handleUnsubscribed(data.unsubscribed);
        if (data.published) return handlePublished(data.published, data);
        console.log('unhandled message data: ' + JSON.stringify(data));
      }

      function handleLoggedIn(logged_in) {
        local_state.recent_messages = logged_in.recent_messages;
        refreshDisplay(local_state);
      }

      function handleSubscribed(subscribed) {
        if (!local_state.recent_messages[subscribed.channel]) {
          local_state.recent_messages[subscribed.channel] = [];
          refreshDisplay(this.local_state);
        }
      }

      function handleUnsubscribed(unsubscribed) {
        if (!local_state.recent_messages[unsubscribed.channel]) {
          delete local_state.recent_messages[unsubscribed.channel];
          refreshDisplay(local_state);
        }
      }

      function handlePublished(published, whole) {
        // add to the recent_messages local_state
        local_state.recent_messages[published.channel].push(whole);
        refreshDisplay(local_state);
      }

      // A very weak substitute for ReactJS
      function refreshDisplay(local_state) {
        // add the channel options to the publish_channel select
        var select = $('#publish_channel');
        select.empty(); // remove existing options
        for (var channel in local_state.recent_messages) {
          select.append('<option value="' + channel + '">' + channel + '</option>');
        }

        // add the publisheds, in "id" order
        // FIXME: need to add a timestamp field to "published"
        var publisheds = $('#publisheds');
        publisheds.empty(); // remove existing messages
        for (var channel in local_state.recent_messages) {
          for (var i in local_state.recent_messages[channel]) {
            publisheds.append('<li>' + JSON.stringify(local_state.recent_messages[channel][i]) + '</li>');
          }
        }
      }

      function handleSubscribeButtonClick() {
        console.log('handleSubscribeButtonClick');
        var channel = $('#subscribe_channel').val();
        send(JSON.stringify({subscribe:{channel:channel}}));
        $('#subscribe_channel').val('');
      }

      function handlePublishButtonClick() {
        console.log('handleSubscribeButtonClick');
        var channel = $('#publish_channel').val();
        var data = $('#message').val();
        send(JSON.stringify({publish:{channel:channel,data:data}}));
        $('#message').val('');
      }

    </script>
  </head>
  <body>
    <h1>pubsub placeholder app</h1>
    <h2>comms log:</h2>
    <ul id="comms_log"></ul>
    <br/>
    <h2>subscribe to a new channel</h2>
    <form>
      <input id="subscribe_channel" type="text">
      <button id="subscribe" onclick="handleSubscribeButtonClick(); return false;">Subscribe</button>
    </form>
    <p>(unsubscribe coming soon...)</p>
    <br/>
    <h2>published content:</h2>
    <ul id="publisheds"></ul>
    <br/>
    <h2>publish a new message</h2>
    <form>
      <select id="publish_channel">
      <input id="message" type="text">
      <button id="publish" onclick="handlePublishButtonClick(); return false;">Publish</button>
    </form>
    <p>(if the select box has no options, you have not yet subscribed to any channels, since the server was started)</p>
  </body>
</html>	
