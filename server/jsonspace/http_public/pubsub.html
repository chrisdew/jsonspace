<!doctype html>
<html>
  <head>  
    <meta charset="utf-8">  
    <title>comms placeholder</title>  
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script>
      var addMessage = function(message) {
        $('<li>' + message + '</li>').appendTo('#messages');
      };

      var ws_url = 'ws://localhost:8888/pubsub';
      console.log('ws_url', ws_url);
      var sock = false;

      // local application state
      var local_state = {
        channels: {}, // a set of currently subscribed channels
        username: null
      };

      var path_array = window.location.pathname.split('/');
      local_state.username = path_array[2];


      // this function is overridden, once the socket has connected
      var send = function(data) {
        $('#comms_log').append('<li>cannot send:' + data + '</li>');
      };

      $(function() {
        sock = new WebSocket(ws_url);
        // TODO: add websocket reconnection logic
        sock.onopen = function() {
          $('#comms_log').append('<li>connected:' + ws_url + '</li>');
          // a send function, to aid logging
          send = function(data) {
            $('#comms_log').append('<li>sent:' + data + '</li>');
            sock.send(data);
          };
          sock.onmessage = function(message) {
            $('#comms_log').append('<li>rx:' + message.data + '</li>');
            var data = JSON.parse(message.data);
            handleMessageData(data);
          };
        };
        sock.onclose = function() {
          $('#comms_log').append('<li>websocket closed by server, please refresh page to continue</li>');
          send = function(data) { $('#comms_log').append('<li>cannot send:' + data + ', due to socket closure</li>'); };
        };
        sock.onerror = function(err) {
          $('#comms_log').append('<li>websocket error: ' + err + '</li>');
          send = function(data) { $('#comms_log').append('<li>cannot send:' + data + ', due to socket error</li>'); };
        };
      });

      function handleMessageData(data) {
        console.log('message data:', data);
        if (data.subscribed) return handleSubscribed(data.subscribed);
        if (data.unsubscribed) return handleUnsubscribed(data.unsubscribed);
        if (data.published) return handlePublished(data.published, data);
        console.log('unhandled message data: ' + JSON.stringify(data));
      }

      function handleSubscribed(subscribed) {
        if (subscribed.username === local_state.username) {
          if (!local_state.channels[subscribed.channel]) {
            local_state.channels[subscribed.channel] = true;
            refreshDisplay(this.local_state);
          }
        }
      }

      function handleUnsubscribed(unsubscribed) {
        if (unsubscribed.username === local_state.username) {
          if (!local_state.channels[unsubscribed.channel]) {
            delete local_state.channels[unsubscribed.channel];
            refreshDisplay(local_state);
          }
        }
      }

      function handlePublished(published, whole) {
        // not maintaining a display separate from the comms_log anymore
      }

      // A very weak substitute for ReactJS
      function refreshDisplay(local_state) {
        // add the channel options to the publish_channel select
        var select = $('#publish_channel');
        select.empty(); // remove existing options
        for (var channel in local_state.channels) {
          select.append('<option value="' + channel + '">' + channel + '</option>');
        }
      }

      function handleSubscribeButtonClick() {
        console.log('handleSubscribeButtonClick');
        var channel = $('#subscribe_channel').val();
        var extra = $('#subscribe_extra').val();
        send(JSON.stringify({subscribe:{username:local_state.username,channel:channel,extra:extra}}));
        $('#subscribe_channel').val('');
        $('#subscribe_extra').val('');
      }

      function handlePublishButtonClick() {
        console.log('handleSubscribeButtonClick');
        var channel = $('#publish_channel').val();
        var data = $('#message').val();
        send(JSON.stringify({publish:{channel:channel,data:data}}));
        $('#message').val('');
      }

    </script>
  </head>
  <body>
    <h1>pubsub placeholder app</h1>
    <h2>comms log:</h2>
    <ul id="comms_log"></ul>
    <br/>
    <h2>subscribe to a new channel</h2>
    <form>
      <input id="subscribe_channel" type="text">
      <input id="subscribe_extra" type="text">
      <button id="subscribe" onclick="handleSubscribeButtonClick(); return false;">Subscribe</button>
    </form>
    <p>(unsubscribe coming soon...)</p>
    <br/>
    <h2>publish a new message</h2>
    <form>
      <select id="publish_channel">
      <input id="message" type="text">
      <button id="publish" onclick="handlePublishButtonClick(); return false;">Publish</button>
    </form>
    <p>(if the select box has no options, you have not yet subscribed to any channels, since the server was started)</p>
  </body>
</html>	
